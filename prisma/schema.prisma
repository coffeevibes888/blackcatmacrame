generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Product {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String      @unique(map: "product_slug_idx")
  category    String
  subCategory String?
  images      String[]
  imageColors String[]   @default([])
  brand       String
  description String
  stock       Int
  price       Decimal     @default(0) @db.Decimal(12, 2)
  rating      Decimal     @default(0) @db.Decimal(3, 2)
  numReviews  Int         @default(0)
  isFeatured  Boolean     @default(false)
  banner      String?
  printfulProductId String?
  onSale      Boolean     @default(false)
  salePercent Decimal?    @db.Decimal(5, 2)
  saleUntil   DateTime?   @db.Timestamp(6)
  createdAt   DateTime    @default(now()) @db.Timestamp(6)
  OrderItem   OrderItem[]
  Review      Review[]

  variants ProductVariant[]
  productPromos ProductPromo[]
}

model User {
  id                  String                           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                String                           @default("NO_NAME")
  email               String                           @unique(map: "user_email_idx")
  emailVerified       DateTime?                        @db.Timestamp(6)
  image               String?
  password            String?
  role                String                           @default("user")
  shippingAddress     Json?                            @db.Json
  billingAddress      Json?                            @db.Json
  address             Json?                            @db.Json
  paymentMethod       String?
  phoneNumber         String?
  phoneVerified       DateTime?                        @db.Timestamp(6)
  createdAt           DateTime                         @default(now()) @db.Timestamp(6)
  updatedAt           DateTime                         @updatedAt
  account             Account[]
  session             Session[]
  Cart                Cart[]
  Order               Order[]
  Review              Review[]
  savedPaymentMethods SavedPaymentMethod[]
  paymentMethodTokens PaymentMethodVerificationToken[]
  threadParticipants  ThreadParticipant[]
  friends             Friend[]                        @relation("UserFriends")
  friendOf            Friend[]                        @relation("UserFriendOf")
  blogPosts           BlogPost[]
  blogComments        BlogComment[]
  blogReactions       BlogReaction[]
}

model Account {
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([provider, providerAccountId])
}

model Session {
  sessionToken String   @id
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamp(6)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@id([identifier, token])
}

model EmailVerificationToken {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([email])
}

model PasswordResetToken {
  id      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email   String
  token   String   @unique
  expires DateTime

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([email])
}

model PhoneVerificationToken {
  id       String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId   String   @db.Uuid
  phone    String
  otp      String
  expires  DateTime
  attempts Int      @default(0)

  createdAt DateTime @default(now()) @db.Timestamp(6)

  @@index([userId])
  @@index([phone])
}

model Cart {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId        String?  @db.Uuid
  sessionCartId String
  items         Json[]   @default([]) @db.Json
  itemsPrice    Decimal  @db.Decimal(12, 2)
  totalPrice    Decimal  @db.Decimal(12, 2)
  shippingPrice Decimal  @db.Decimal(12, 2)
  taxPrice      Decimal  @db.Decimal(12, 2)
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  user          User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Order {
  id                 String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String      @db.Uuid
  shippingAddress    Json        @db.Json
  paymentMethod      String
  paymentResult      Json?       @db.Json
  itemsPrice         Decimal     @db.Decimal(12, 2)
  shippingPrice      Decimal     @db.Decimal(12, 2)
  taxPrice           Decimal     @db.Decimal(12, 2)
  totalPrice         Decimal     @db.Decimal(12, 2)
  isPaid             Boolean     @default(false)
  paidAt             DateTime?   @db.Timestamp(6)
  isDelivered        Boolean     @default(false)
  deliveredAt        DateTime?   @db.Timestamp(6)
  trackingNumber     String?     @unique
  trackingStatus     String?     @default("pending")
  trackingEvents     Json[]      @default([]) @db.Json
  lastTrackingUpdate DateTime?   @db.Timestamp(6)
  createdAt          DateTime    @default(now()) @db.Timestamp(6)
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  orderitems         OrderItem[]
}

model OrderItem {
  orderId      String  @db.Uuid
  productId    String  @db.Uuid
  qty          Int
  price        Decimal @db.Decimal(12, 2)
  name         String
  slug         String
  image        String
  variantId    String? @db.Uuid
  variantColor String?
  variantSize  String?
  order        Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@id([orderId, productId], map: "orderitems_orderId_productId_pk")
}

model Color {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String           @unique
  hex       String?
  active    Boolean          @default(true)
  createdAt DateTime         @default(now()) @db.Timestamp(6)
  variants  ProductVariant[]
}

model Size {
  id        String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String           @unique
  active    Boolean          @default(true)
  createdAt DateTime         @default(now()) @db.Timestamp(6)
  variants  ProductVariant[]
}

model ProductVariant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String   @db.Uuid
  sku       String?  @unique
  colorId   String?  @db.Uuid
  sizeId    String?  @db.Uuid
  images    String[] @default([])
  price     Decimal  @db.Decimal(12, 2)
  stock     Int
  printfulExternalId String?
  createdAt DateTime @default(now()) @db.Timestamp(6)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  color   Color?  @relation(fields: [colorId], references: [id], onDelete: SetNull)
  size    Size?   @relation(fields: [sizeId], references: [id], onDelete: SetNull)
}

model Review {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId             String   @db.Uuid
  productId          String   @db.Uuid
  rating             Int
  title              String
  description        String
  isVerifiedPurchase Boolean  @default(true)
  createdAt          DateTime @default(now()) @db.Timestamp(6)
  product            Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SavedPaymentMethod {
  id                    String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String   @db.Uuid
  stripePaymentMethodId String   @unique
  type                  String
  cardholderName        String?
  last4                 String
  expirationDate        String?
  brand                 String?
  billingAddress        Json?    @db.Json
  isDefault             Boolean  @default(false)
  isVerified            Boolean  @default(false)
  createdAt             DateTime @default(now()) @db.Timestamp(6)
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripePaymentMethodId])
}

model PaymentMethodVerificationToken {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId          String   @db.Uuid
  paymentMethodId String   @db.Uuid
  token           String   @unique
  expires         DateTime
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Coupon {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique
  description String?
  discountType String  @default("percentage")
  discountValue Decimal @db.Decimal(10, 2)
  minOrderAmount Decimal? @db.Decimal(12, 2)
  maxUses    Int?
  usedCount  Int      @default(0)
  isActive   Boolean  @default(true)
  expiresAt  DateTime?
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt

  @@index([code])
}

model PromoCode {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique
  description String?
  discountType String  @default("percentage")
  discountValue Decimal @db.Decimal(10, 2)
  minOrderAmount Decimal? @db.Decimal(12, 2)
  maxUses    Int?
  usedCount  Int      @default(0)
  isActive   Boolean  @default(true)
  expiresAt  DateTime?
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt

  @@index([code])

  productPromos ProductPromo[]
}

model ProductPromo {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId   String   @db.Uuid
  promoCodeId String   @db.Uuid

  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  promoCode PromoCode @relation(fields: [promoCodeId], references: [id], onDelete: Cascade)

  @@unique([productId, promoCodeId])
}

model ShippingSettings {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  baseShippingCost Decimal @db.Decimal(10, 2)
  freeShippingThreshold Decimal @db.Decimal(12, 2)
  uspsIntegrationEnabled Boolean @default(false)
  updatedAt       DateTime @updatedAt

  @@unique([id])
}

model TaxSettings {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  taxRate         Decimal  @db.Decimal(5, 2)
  updatedAt       DateTime @updatedAt

  @@unique([id])
}

model Thread {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type            String   @default("contact") // contact, support, dm
  subject         String?
  fromEmail       String?
  toEmail         String?
  createdByUserId String?  @db.Uuid
  status          String   @default("open") // open, closed, pending
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @updatedAt

  messages     Message[]
  participants ThreadParticipant[]
}

model Message {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId      String   @db.Uuid
  senderUserId  String?  @db.Uuid
  senderName    String?
  senderEmail   String?
  content       String
  role          String   @default("user") // user, admin, system, ai
  createdAt     DateTime @default(now()) @db.Timestamp(6)

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
}

model ThreadParticipant {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  threadId   String   @db.Uuid
  userId     String   @db.Uuid
  lastReadAt DateTime?

  thread Thread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
}

model Friend {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @db.Uuid
  friendId  String   @db.Uuid
  status    String   @default("pending") // pending, accepted, declined, blocked
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt

  user   User @relation("UserFriends", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("UserFriendOf", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
}

model BlogPost {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title       String
  slug        String   @unique
  excerpt     String?
  contentHtml String
  coverImage  String?
  mediaUrls   String[] @default([])
  tags        String[] @default([])
  isPublished Boolean  @default(true)
  authorId    String?  @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt

  author User? @relation(fields: [authorId], references: [id], onDelete: SetNull)

  comments  BlogComment[]
  reactions BlogReaction[]
}

model BlogComment {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postId    String   @db.Uuid
  userId    String   @db.Uuid
  content   String
  createdAt DateTime @default(now()) @db.Timestamp(6)

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId])
}

model BlogReaction {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postId    String   @db.Uuid
  userId    String   @db.Uuid
  type      String   @default("like") // like/heart, future types
  createdAt DateTime @default(now()) @db.Timestamp(6)

  post BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, type])
  @@index([postId])
}

model AnalyticsEvent {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionCartId String
  userId        String?  @db.Uuid
  path          String
  referrer      String?
  country       String?
  region        String?
  city          String?
  userAgent     String?
  ip            String?
  
  // Enhanced tracking fields
  eventType     String?  // 'pageview', 'click', 'scroll', 'exit', etc.
  eventData     Json?    @db.Json // Flexible field for event-specific data
  
  // User behavior
  timeOnPage    Int?     // Seconds spent on page
  scrollDepth   Int?     // Percentage scrolled (0-100)
  
  // Device & technical
  screenWidth   Int?
  screenHeight  Int?
  deviceType    String?  // 'mobile', 'tablet', 'desktop'
  browserLang   String?  // Browser language preference
  
  // Marketing attribution
  utmSource     String?  // UTM source parameter
  utmMedium     String?  // UTM medium parameter  
  utmCampaign   String?  // UTM campaign parameter
  utmContent    String?  // UTM content parameter
  utmTerm       String?  // UTM term parameter
  
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  
  @@index([sessionCartId])
  @@index([userId])
  @@index([path])
  @@index([createdAt])
  @@index([eventType])
  @@index([ip])
}

model SupportStatus {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  isOnline  Boolean  @default(true)
  updatedBy String?  @db.Uuid
  updatedAt DateTime @default(now()) @db.Timestamp(6)
}

model BlockedIp {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  ip        String   @unique
  reason    String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  createdBy String?  @db.Uuid
}

// Product interaction tracking
model ProductView {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId     String   @db.Uuid
  sessionCartId String
  userId        String?  @db.Uuid
  ip            String?
  country       String?
  duration      Int?     // Seconds spent viewing product
  variantViewed String?  // Which variant/color/size
  fromPage      String?  // Referrer page
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  
  @@index([productId])
  @@index([sessionCartId])
  @@index([userId])
  @@index([createdAt])
}

// Cart abandonment and events
model CartEvent {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionCartId String
  userId        String?  @db.Uuid
  eventType     String   // 'add', 'remove', 'update_qty', 'abandon', 'checkout_started'
  productId     String?  @db.Uuid
  variantId     String?  @db.Uuid
  quantity      Int?
  price         Decimal? @db.Decimal(12, 2)
  ip            String?
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  
  @@index([sessionCartId])
  @@index([userId])
  @@index([eventType])
  @@index([productId])
  @@index([createdAt])
}

// Search tracking for product discovery
model SearchQuery {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionCartId String
  userId        String?  @db.Uuid
  query         String
  resultsCount  Int?     // How many results returned
  clickedResult String?  // Which product they clicked
  ip            String?
  createdAt     DateTime @default(now()) @db.Timestamp(6)
  
  @@index([sessionCartId])
  @@index([userId])
  @@index([query])
  @@index([createdAt])
}

// Failed login attempts for security
model SecurityEvent {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  eventType  String   // 'failed_login', 'suspicious_activity', 'bot_detected'
  ip         String
  email      String?
  userAgent  String?
  country    String?
  details    Json?    @db.Json
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  
  @@index([ip])
  @@index([eventType])
  @@index([createdAt])
}
